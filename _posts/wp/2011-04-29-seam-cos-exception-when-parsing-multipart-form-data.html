---
layout: post
title: Seam中cos多文件上传出现异常
categories:
- Seam
tags:
- cos
- Filter
- MultipartRequest
- Seam
published: true
comments: true
---
<p>忙了一晚上，记录一下遇到的问题以及解决办法。</p>

<p>做了一个上传的功能，由于用到了其他的一些开源组件，没法和seam以及jsf集成起来，故只能用其他的上传的方法。</p>

<p>上传的方法很多，比如：jspsmart公司的jspsmartupload组件，O`Rrilly公司的cos组件，Jakarta Apache公司的commonsFileUpload组件，JavaZoom的uploadbean组件，还有Struts组件中自带的org.apache.struts.upload类工具等等。</p>

<p>在这里我使用的是cos组件，什么是cos组件？可以参阅【<a href="http://tmsoft.lsxy.com/index.php?id=404&amp;load=read">java中几种上传方法介绍、比较</a>】<!--more--></p>

<p>使用cos上传的核心代码如下：
<pre lang="java">request.setCharacterEncoding("UTF-8");
response.setCharacterEncoding("UTF-8");
response.setContentType("text/plain;charset=utf-8");
String saveDirectory = this.getServletContext().getRealPath("uploadFiles");
File dir = new File(saveDirectory);</pre></p>

<p>if (!dir.isDirectory()) {<br />
	dir.mkdir();<br />
}
MultipartRequest multi = new MultipartRequest(request, saveDirectory,<br />
		100 * 1024 * 1024, "UTF-8",<br />
		new Edo.util.RandomFileRenamePolicy());<br />
Enumeration files = multi.getFileNames();<br />
while (files.hasMoreElements()) {<br />
	String name = (String) files.nextElement();<br />
	File f = multi.getFile(name);<br />
	if (f != null) {<br />
		String fileName = multi.getFilesystemName(name);<br />
		Map project = null;<br />
		try {<br />
			project = Edo.util.Import.ImportFile(saveDirectory + "/"<br />
					+ fileName);<br />
			String json = Edo.util.JSON.encode(project);</p>

<p>			response.getWriter().write(json);<br />
		} catch (Exception e) {<br />
			e.printStackTrace();<br />
		}<br />
	}<br />
}
上面代码在一般的环境中不会报错，但是在seam的环境中就会报错，报出的异常如下：</p>

<p><strong>java.io.IOException: Corrupt form data: premature ending </strong></p>

<p>这个异常也会出现在struts等其他框架中，在网上可以搜到相关的文章。</p>

<p>针对该问题该如何解决呢？</p>

<p>这篇文章提到了一种问题出现的原因：【<a href="http://stackoverflow.com/questions/595744/exception-when-parsing-multipart-form-data">http://stackoverflow.com/questions/595744/exception-when-parsing-multipart-form-data</a>】</p>

<p>摘除如下：
<blockquote>This indicates there was a problem parsing the POST request submitted by the client. There can be many causes for the problem:</blockquote></p>

<p>The client hit the STOP button (not really a problem, but it does cause a premature ending)</p>

<p>A bug in the web form</p>

<p>A bug in the servlet</p>

<p>A bug in the web server</p>

<p>A bug in the browser</p>

<p>A bug in the com.oreilly.servlet library itself
针对上面的几种原因分析，最有可能的是在servlet或是web server，但是为什么在普通的java web环境里上传不报错，在seam环境中就报错呢？这时候仔细看看异常信息，就会发现在报这个错之前执行了好几个过滤器。估计最有可能是过滤器导致的了。</p>

<p>过滤器会做些什么事情呢？通常用于拦截请求和响应。会不会是过滤器改变请求的一些信息呢？会是哪个过滤器导致请求被修改了呢？可不可以通过过滤器的拦截url来避开当前上传的servlet的url地址呢（这样做貌似不是最佳的解决办法）？</p>

<p>仔细想想，现在上传用的是MultipartRequest ，会不会是多文件提交的过滤器导致的呢？如果是怎样关闭该过滤器呢？</p>

<p>这时候查查seam的过滤器知识（查看满江红的【<a href="http://www.redsaga.com/opendoc/Seam2.0/html/configuration.html"> Seam配置和Seam应用程序打包</a>】），然后看看seam的多重表单提交过滤器（web:multipart-filte）源码就会看的很清楚了。
<blockquote>当使用Seam文件上传JSF控件时，这个特性很有必要。它依据多重表单/数据规范（RFC-2388）检测并处理多重表单请求。 要覆盖默认设置，向 components.xml 中增加以下项：</blockquote></p>

<p>create-temp-files — 如果设置为 true，加载的文件被写到临时文件中（而不是保留在内存中）。 如果期望加载大文件，这个设置可能是一个很重要的考虑因素。默认的设置是 false。</p>

<p>max-request-size — 如果加载请求中的文件大小（由读取请求中 Content-Length 头的的值决定）超过这个值，该请求将被中止。默认设置是0（大小不限）。</p>

<p>url-pattern — 被用来指定过滤哪些请求，默认是所有请求。
找到问题原因所在，如何解决呢？<br />
参考【<a href="http://lxh2002.iteye.com/blog/364218">Seam中文件的上传（使用Apache-Common-FileUpload组件）</a>】。</p>

<p>原来可以关闭seam内建的过滤器，上面文章给出的方法是：
<blockquote>在components.xml中增加下面一句：</blockquote></p>

<p>&lt; web:multipart-filter disabled="true"/&gt;
我用的是seam2.2，在components.xml中添加上面一句会报错。这时候在网上搜搜org.jboss.seam.web.multipartFilter的相关信息，会发现org.jboss.seam.web.multipartFilter该组件有以下属性：</p>

<p>class org.jboss.seam.web.MultipartFilter</p>

<p>createTempFiles false</p>

<p>disabled false</p>

<p>maxRequestSize 0</p>

<p>regexUrlPattern</p>

<p>urlPattern</p>

<p>toString() org.jboss.seam.web.MultipartFilter@ca0188</p>

<p>并且，在现有的components.xml中看的了以下配置信息：
<pre lang="xml">
< component name="org.jboss.seam.remoting.remoting">
	<property name="debug >false< /property>
</pre>
参照上面就找到解决办法了,在components.xml中加以下配置：
<pre lang="xml">
< component name="org.jboss.seam.remoting.remoting">
	property<property name="debug >true< /property>
</property></pre>
</p></pre></p>
